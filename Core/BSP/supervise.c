/**
  ******************************************************************************
  * ???        ?supervise.c
	* ????      ?2019.11.10
	* ??          ???????
	*-----------------------------------------------------------------------------
	* ??????  ?2020.1.29
	* ???        ????
  ******************************************************************************
	* 1.?????STM32F427IIH6????????Keil 5???FreeRTOS????
	* 2.???????Robomaster???
	* 3.????????????????????
	* 4.??????????????ANSI??????
	* 5.??????????????????????????Critical HIT??
	* 
	* Copyright (c) ?????????????????Critical HIT ????
	******************************************************************************
  */

#include "supervise.h"
#include "string.h"

#ifdef Heat_Test
#include "Can_motor.h"
#endif

Monitor_t Monitor;
static uint16_t lost_state = 0;                  //???????????16?
static int lost_counter[DETECT_NUM] = {0};       //????????????????????????

/**
* @brief ??????
* @param FPS struct
* @retval None
*/
void FrameRateStatistics(FPS_t *FPS)
{
	FPS->count++;
	FPS->now = HAL_GetTick();
	int error = FPS->now - FPS->last;
	if(error >= 1000)
	{
		FPS->FPS = FPS->count * 1000 / error;
		FPS->count = 0;
		FPS->last = FPS->now;
	}
}

/**
* @brief ??????????????
* @param ??????
* @retval None
*/
void LostCounterFeed(int index){
	if(index == 0)
		return ;
	lost_counter[index] = 0;
}

/**
* @brief ??????????????
* @param None
* @retval None
*/
void LostCounterFeed_Remote(void){
	lost_counter[0] = 0;
}

/**
* @brief ???????
* @brief ?????????????
* @param None
* @retval None
*/
void SuperVise()
{
	for(int i = 0;i < DETECT_NUM;i++)     //?????????0?????1~7????
	{
		if(lost_counter[i] < 200)    //????????????????????0
		{
			lost_counter[i]++;
			lost_state &= ~(1<<i);
		}
		else
			lost_state |= (1<<i);
	}
	
	memset(&Monitor,0,16);        //???????
	
	if(lost_state & 0x01)         //???????????
	{
		// HAL_GPIO_WritePin(GPIOC, GPIO_PIN_14, GPIO_PIN_RESET);      //???????????????
		Monitor.RC_lost = 1;
	}
	else
	{
		// HAL_GPIO_WritePin(GPIOC, GPIO_PIN_14, GPIO_PIN_SET);      //???????????????
		Monitor.RC_lost = 0;
	}
	
	if(lost_state & 0x01E)  //0b00000011110??
		Monitor.Chassis_lost = 1;      //????
	else
		Monitor.Chassis_lost = 0;
	if(lost_state & 0x060)  //0b00001100000??
		Monitor.Gimbal_lost = 1;      //????	
	else
		Monitor.Gimbal_lost = 0;
	if(lost_state & 0x080)  //0b00010000000??
		Monitor.Shoot_lost = 1;      //??????	
	else
		Monitor.Shoot_lost = 0;
	
	if(lost_state & 0x0800)
		Monitor.IMU_lost = 1;
	else
		Monitor.IMU_lost = 0;
	if(lost_state & 0x1000)
		Monitor.PC_lost = 1;
	else
		Monitor.PC_lost = 0;
	if(lost_state & 0x2000)
		Monitor.board_lost = 1;
	else
		Monitor.board_lost = 0;
	if(lost_state & 0x4000)
		Monitor.PC_Chassis_lost = 1;
	else
		Monitor.PC_Chassis_lost = 0;
	
	#ifdef Heat_Test                  //??????????????????????????????
	if(m3508_1.temperature > 50.0f || m3508_2.temperature > 50.0f || m3508_3.temperature > 50.0f ||  m3508_4.temperature > 50.0f)
		Monitor.Heat_lost = 1;
	#endif
}
